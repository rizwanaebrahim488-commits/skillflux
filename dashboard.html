<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillFlux | Exchange Board</title>
    <style>
        :root { --bg: #000; --flux: #3b82f6; --card: #0a0a0a; --border: #1e293b; --text: #94a3b8; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; padding: 40px 6%; opacity: 0; transition: 0.5s; }
        nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 60px; }
        .vault-card { background: var(--card); border: 1px solid var(--flux); padding: 25px 40px; border-radius: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; margin-top: 40px; }
        .skill-card { background: var(--card); border: 1px solid var(--border); aspect-ratio: 1/1; padding: 35px; border-radius: 30px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s; }
        .skill-card:hover { border-color: var(--flux); transform: translateY(-5px); }
        .post-form { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 25px; margin-bottom: 50px; display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; }
        input { background: #000; border: 1px solid var(--border); padding: 15px; border-radius: 10px; color: white; outline: none; }
        button { background: var(--flux); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
    <nav>
        <h1 style="font-size:2rem; font-weight:900;">Skill<span style="color:var(--flux)">Flux</span></h1>
        <div class="vault-card">
            <small style="letter-spacing:2px;">LIQUIDITY</small>
            <h1 id="user-credits" style="font-size:3rem;">0</h1>
        </div>
        <button style="background:#ef4444" onclick="handleLogout()">Logout</button>
    </nav>

    <div class="post-form">
        <div><label style="font-size:0.7rem; color:var(--text)">SKILL</label><br><input type="text" id="s-title" style="width:100%"></div>
        <div><label style="font-size:0.7rem; color:var(--text)">OFFER</label><br><input type="text" id="s-desc" style="width:100%"></div>
        <button onclick="postSkill()">List Expertise</button>
    </div>

    <div class="grid" id="market"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHSJX5F_mZjLqPSuofyBANQ3pC69gC14o",
            authDomain: "skillflux-c4088.firebaseapp.com",
            projectId: "skillflux-c4088",
            storageBucket: "skillflux-c4088.appspot.com",
            messagingSenderId: "347039323368",
            appId: "1:347039323368:web:0f610227dc3715581a255d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let uData = null;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.body.style.opacity = "1";
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    uData = d.data();
                    document.getElementById('user-credits').innerText = uData.credits;
                });
                loadSkills();
            } else { window.location.href = "index.html"; }
        });

        window.postSkill = async () => {
            const title = document.getElementById('s-title').value;
            const desc = document.getElementById('s-desc').value;
            if(!title || !desc) return;
            await addDoc(collection(db, "skills"), { title, desc, owner: auth.currentUser.uid, email: auth.currentUser.email, createdAt: new Date() });
            document.getElementById('s-title').value = ''; document.getElementById('s-desc').value = '';
        };

        function loadSkills() {
            onSnapshot(query(collection(db, "skills"), orderBy("createdAt", "desc")), (snap) => {
                const m = document.getElementById('market'); m.innerHTML = '';
                snap.forEach(d => {
                    const s = d.data();
                    const isMine = s.owner === auth.currentUser.uid;
                    m.innerHTML += `<div class="skill-card">
                        <div><small style="color:var(--flux); letter-spacing:1px;">PEER OFFER</small><h3>${s.title}</h3><p style="color:var(--text);">${s.desc}</p></div>
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid var(--border); padding-top:15px;">
                            <b>1 FLUX</b>
                            ${!isMine ? `<button style="background:white; color:black;" onclick="buy('${d.id}','${s.owner}','${s.email}','${s.title}')">Acquire</button>` : '<i style="font-size:0.8rem">Own Posting</i>'}
                        </div>
                    </div>`;
                });
            });
        }

        window.buy = async (id, sId, sEmail, title) => {
            if(uData.credits < 1) return alert("Insufficient Liquidity.");
            if(!confirm("Exchange 1 Credit?")) return;
            try {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { credits: uData.credits - 1 });
                const sDoc = await getDoc(doc(db, "users", sId));
                await updateDoc(doc(db, "users", sId), { credits: sDoc.data().credits + 1 });
                window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=SkillFlux:${title}&add=${sEmail}`, '_blank');
            } catch (e) { alert("Transaction failed."); }
        };

        window.handleLogout = () => signOut(auth);
    </script>
</body>
</html>
