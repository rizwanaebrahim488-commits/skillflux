<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SkillFlux | Exchange Dashboard</title>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --blue: #3b82f6; --border: #262626; --text: #e5e5e5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 80px 5% 40px; }
        nav { position: fixed; top:0; width:100%; height:70px; display:flex; justify-content:space-between; align-items:center; padding:0 5%; background:rgba(10,10,10,0.9); border-bottom:1px solid var(--border); z-index:1000; box-sizing:border-box; }
        .credit-box { background: var(--card); border: 1px solid var(--blue); padding: 10px 25px; border-radius: 10px; text-align:center; }
        .upload-card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 16px; margin-bottom: 30px; }
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .skill-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; }
        .btn { background: var(--blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        input { padding: 12px; background: #000; border: 1px solid var(--border); color: white; border-radius: 8px; width: 300px; margin-right: 10px; }
    </style>
</head>
<body>
    <nav>
        <div style="font-size: 1.2rem; font-weight: 700;">SkillFlux</div>
        <div class="credit-box">
            <small>MY BALANCE</small>
            <div id="user-credits" style="font-size: 1.5rem; font-weight: 900; color:var(--blue);">0</div>
        </div>
        <button onclick="auth.signOut()" class="btn" style="background:#ef4444; padding:5px 10px;">Exit</button>
    </nav>

    <div class="upload-card">
        <h3>Post an Offer</h3>
        <p style="color:#a3a3a3; font-size: 0.9rem;">Sharing your knowledge earns you <b>+2 Credits</b> immediately.</p>
        <input type="text" id="skillIn" placeholder="I can teach/help with...">
        <button id="postBtn" class="btn">Upload & Earn +2</button>
    </div>

    <h2>Marketplace</h2>
    <div id="skillFeed" class="skill-grid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { /* USE PREVIOUS CONFIG */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.auth = auth;

        let currentBalance = 0;

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else {
                onSnapshot(doc(db, "users", user.uid), (s) => { 
                    if(s.exists()) {
                        currentBalance = s.data().credits;
                        document.getElementById('user-credits').innerText = currentBalance;
                    }
                });
                loadSkills();
            }
        });

        // POST SKILL = GET 2 CREDITS
        document.getElementById('postBtn').onclick = async () => {
            const skill = document.getElementById('skillIn').value;
            if(!skill) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", auth.currentUser.uid);
                    // 1. Post the skill
                    await addDoc(collection(db, "skills"), { 
                        skill, 
                        owner: auth.currentUser.email, 
                        ownerId: auth.currentUser.uid, 
                        time: new Date() 
                    });
                    // 2. Add 2 credits to balance
                    transaction.update(userRef, { credits: currentBalance + 2 });
                });
                document.getElementById('skillIn').value = '';
                alert("Skill Posted! You earned 2 Credits.");
            } catch (e) { alert(e.message); }
        };

        // ACQUIRE SKILL = SPEND 1 CREDIT
        window.acquireSkill = async (ownerId) => {
            if(ownerId === auth.currentUser.uid) return alert("This is your offer.");
            if(currentBalance < 1) return alert("You need at least 1 credit. Post a skill to earn more!");

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", auth.currentUser.uid);
                    transaction.update(userRef, { credits: currentBalance - 1 });
                });
                alert("Skill Acquired! 1 Credit deducted.");
            } catch (e) { alert(e.message); }
        };

        function loadSkills() {
            const q = query(collection(db, "skills"), orderBy("time", "desc"));
            onSnapshot(q, (snap) => {
                const f = document.getElementById('skillFeed');
                f.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    f.innerHTML += `
                        <div class="skill-card">
                            <strong>${data.skill}</strong><br>
                            <small style="color:#737373">Offered by: ${data.owner}</small>
                            <button onclick="acquireSkill('${data.ownerId}')" class="btn" style="width:100%; margin-top:15px; background:transparent; border:1px solid var(--blue); color:var(--blue);">Acquire (1 Credit)</button>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>
